<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STAT.SYS - Central Database</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<style>
@keyframes blink { 0%,49%{opacity:1;}50%,100%{opacity:0;} }
@keyframes flicker { 0%,100%{opacity:1;}50%{opacity:0.96;} }
@keyframes scanline { 0%{transform:translateY(-100%);}100%{transform:translateY(100vh);} }

* { cursor: none !important; box-sizing: border-box; }

.custom-cursor {
  position: fixed;
  left: 0;
  top: 0;
  width: 12px;
  height: 12px;
  background: #FFFF00;
  pointer-events: none;
  z-index: 99999;
  mix-blend-mode: difference;
}

.login-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background-color: #0000AA;
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: flicker 0.15s infinite;
}

.login-screen::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 2px;
  background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
  animation: scanline 8s linear infinite;
  pointer-events: none;
  z-index: 10001;
}

.login-screen::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
  pointer-events: none;
  z-index: 10001;
}

.login-box {
  background: #C0C0C0;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  padding: 30px;
  box-shadow: 8px 8px 0 #000000;
  z-index: 10002;
  position: relative;
  max-width: 400px;
  width: 90%;
}

.login-header {
  background: linear-gradient(90deg, #000080, #1084d0);
  color: #FFFFFF;
  padding: 6px;
  margin: -30px -30px 20px -30px;
  font-weight: bold;
  font-size: 13px;
  text-align: center;
  font-family: "Courier New", monospace;
}

.login-content { text-align: center; }

.login-content h2 {
  color: #000000;
  margin: 0 0 15px 0;
  font-size: 14px;
  font-weight: bold;
}

.login-input {
  width: 100%;
  padding: 8px;
  font-family: "Courier New", monospace;
  font-size: 14px;
  border: 2px solid;
  border-color: #808080 #FFFFFF #FFFFFF #808080;
  margin-bottom: 15px;
  background: #FFFFFF;
  color: #000000;
}

.login-button {
  padding: 10px 30px;
  background: #C0C0C0;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  font-weight: bold;
  font-size: 13px;
  font-family: "Courier New", monospace;
  cursor: pointer;
  color: #000000;
}

.login-button:hover { background: #DFDFDF; }
.login-button:active { border-color: #000000 #FFFFFF #FFFFFF #000000; }

.login-error {
  color: #FF0000;
  font-weight: bold;
  margin-top: 15px;
  display: none;
  font-size: 12px;
}

.main-content { display: none; }

.admin-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
}
.admin-tab {
  padding: 10px 20px;
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  color: #000;
  font-family: "Courier New", monospace;
  font-weight: bold;
  cursor: pointer;
  font-size: 12px;
}
.admin-tab:hover { background: #d4d4d4; }
.admin-tab.active { background: #000080; color: #fff; }

.admin-section { display: none; }
.admin-section.active { display: block; }

.message-card {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  margin-bottom: 10px;
  padding: 10px;
}
.message-header {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px solid #808080;
  padding-bottom: 5px;
  margin-bottom: 10px;
  color: #000;
  font-size: 11px;
}
.message-content {
  color: #000;
  font-size: 12px;
  white-space: pre-wrap;
  max-height: 200px;
  overflow-y: auto;
  background: #fff;
  padding: 10px;
  border: 1px inset #808080;
}
.message-actions {
  margin-top: 10px;
  display: flex;
  gap: 5px;
}
.message-actions button {
  padding: 4px 10px;
  font-size: 11px;
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  cursor: pointer;
  font-family: "Courier New", monospace;
}
.message-actions button:hover { background: #d4d4d4; }
.message-actions button.danger { background: #ff6666; }
.message-unread { border-left: 4px solid #00ff00; }

body {
  background-color: #0000AA;
  color: #FFFFFF;
  font-family: "Courier New", monospace;
  font-size: 14px;
  margin: 0;
  padding: 40px 20px;
  min-height: 100vh;
  animation: flicker 0.15s infinite;
  text-shadow: 0 0 2px rgba(255,255,255,0.5);
  position: relative;
  overflow-y: auto;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 2px;
  background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
  animation: scanline 8s linear infinite;
  pointer-events: none;
  z-index: 1000;
}

body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
  pointer-events: none;
  z-index: 999;
}

.content { position: relative; z-index: 1; max-width: 1800px; margin: 0 auto; }

.logo {
  border: 2px solid #FFFFFF;
  display: inline-block;
  padding: 4px 16px;
  margin-bottom: 30px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: #fff;
}

.logo:hover { background: #FFFFFF; }
.logo:hover span { color: #0000AA; }

.logo span {
  background-color: #FFFFFF;
  color: #0000AA;
  padding: 0 4px;
  font-weight: bold;
  font-size: 18px;
}

.header {
  text-align: center;
  margin-bottom: 30px;
  font-size: 24px;
  font-weight: bold;
  border-bottom: 3px solid #FFFFFF;
  padding-bottom: 20px;
}

.controls {
  background: #C0C0C0;
  padding: 20px;
  margin-bottom: 20px;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  box-shadow: 4px 4px 0 #000000;
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: flex-end;
}

.control-group { display: flex; flex-direction: column; gap: 5px; }
.control-label { color: #000000; font-weight: bold; font-size: 12px; }

select, input, button {
  padding: 8px;
  font-family: "Courier New", monospace;
  font-size: 14px;
  border: 2px solid;
  border-color: #808080 #FFFFFF #FFFFFF #808080;
  background: #FFFFFF;
  color: #000000;
}

button {
  background: #C0C0C0;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  font-weight: bold;
  cursor: pointer;
  padding: 10px 20px;
}

button:hover { background: #DFDFDF; }
button:active { border-color: #000000 #FFFFFF #FFFFFF #000000; }
button.danger { background: #FF6666; }
button.success { background: #66FF66; }

.stats-table {
  background: #C0C0C0;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  box-shadow: 4px 4px 0 #000000;
  overflow-x: auto;
  margin-bottom: 20px;
}

table { width: 100%; border-collapse: collapse; background: #FFFFFF; }

th, td {
  border: 1px solid #808080;
  padding: 8px 6px;
  text-align: center;
  color: #000000;
  font-size: 12px;
}

th {
  background: linear-gradient(90deg, #000080, #1084d0);
  color: #FFFFFF;
  font-weight: bold;
  position: sticky;
  top: 0;
}

th.sortable { cursor: pointer; }
th.sortable:hover { background: #4040FF; }

td input {
  width: 60px;
  padding: 4px;
  font-size: 12px;
  text-align: center;
}

td.name-cell { text-align: left; font-weight: bold; white-space: nowrap; }

.score-cell { background: #FFD700 !important; font-weight: bold; }

#status {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  background: #00FF00;
  color: #000;
  font-weight: bold;
  display: none;
  z-index: 2000;
  border: 2px solid #000;
}

#jsonOutput {
  background: #000;
  color: #0f0;
  padding: 15px;
  font-size: 11px;
  max-height: 300px;
  overflow: auto;
  display: none;
  white-space: pre-wrap;
  margin-top: 20px;
}

.period-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
.period-buttons button { padding: 8px 12px; font-size: 11px; }
.period-buttons button.active { background: #000080; color: #fff; }

.loading {
  text-align: center;
  padding: 50px;
  font-size: 18px;
  color: #FFFF00;
}

.search-box {
  display: flex;
  gap: 10px;
  align-items: center;
}

.search-box input { width: 200px; }
</style>
</head>
<body>
<div class="custom-cursor" id="cursor"></div>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-header">üîí STAT.SYS - ACC√àS RESTREINT</div>
    <div class="login-content">
      <h2>IDENTIFICATION REQUISE</h2>
      <input type="password" class="login-input" id="passwordInput" placeholder="Mot de passe..." onkeypress="if(event.key==='Enter')checkPassword()">
      <br>
      <button class="login-button" onclick="checkPassword()">CONNEXION</button>
      <div class="login-error" id="loginError">‚ùå MOT DE PASSE INCORRECT</div>
    </div>
  </div>
  <div id="brumeLink" style="margin-top:10px;color:#ffb6c1;font-size:9px;cursor:pointer;opacity:0.5">brume</div>
</div>

<!-- Main Content -->
<div class="main-content" id="mainContent">
  <div class="content">
    <a href="menu.html" class="logo"><span>:vitalism</span></a>
    
    <div class="header">
      üìä STAT.SYS - BASE DE DONN√âES CENTRALE<br>
      <span style="font-size:12px;opacity:0.7">68 contributeurs | Derni√®re MAJ: <span id="lastUpdate">--</span></span>
    </div>
    
    <div id="status"></div>
    
    <!-- Onglets Admin -->
    <div class="admin-tabs">
      <div class="admin-tab active" onclick="showAdminTab('stats')">üìä STATISTIQUES</div>
      <div class="admin-tab" onclick="showAdminTab('candidatures')">üìù CANDIDATURES <span id="candCount"></span></div>
      <div class="admin-tab" onclick="showAdminTab('anone')">‚úâÔ∏è MESSAGES ANONE <span id="anoneCount"></span></div>
    </div>
    
    <!-- Section Statistiques -->
    <div class="admin-section active" id="sectionStats">
    <div class="controls">
      <div class="control-group">
        <span class="control-label">P√âRIODE:</span>
        <div class="period-buttons" id="periodButtons">
          <button onclick="setPeriod('y2018')">2018</button>
          <button onclick="setPeriod('y2019')">2019</button>
          <button onclick="setPeriod('y2020')">2020</button>
          <button onclick="setPeriod('y2021')">2021</button>
          <button onclick="setPeriod('y2022')">2022</button>
          <button onclick="setPeriod('y2023')">2023</button>
          <button onclick="setPeriod('y2024')">2024</button>
          <button onclick="setPeriod('y2025')">2025</button>
          <button onclick="setPeriod('y2026')" class="active">2026</button>
        </div>
      </div>
      
      <div class="control-group search-box">
        <span class="control-label">RECHERCHE:</span>
        <input type="text" id="searchInput" placeholder="Nom..." oninput="filterTable()">
      </div>
      
      <div class="control-group">
        <span class="control-label">CONTRIBUTEUR:</span>
        <select id="contributorSelect" onchange="scrollToContributor()">
          <option value="">-- S√©lectionner --</option>
        </select>
      </div>
      
      <button onclick="saveData()" class="success">üíæ SAUVEGARDER</button>
      <button onclick="exportJSON()">üì§ EXPORTER JSON</button>
      <button onclick="loadFromJSON()">üì• RECHARGER JSON</button>
    </div>
    
    <div class="stats-table">
      <table>
        <thead>
          <tr>
            <th class="sortable" onclick="sortTable('name')">NOM ‚ñº</th>
            <th class="sortable" onclick="sortTable('books')">üìö LIVRES</th>
            <th class="sortable" onclick="sortTable('articles')">üìù ARTICLES</th>
            <th class="sortable" onclick="sortTable('video_minutes')">üé¨ VID√âO (min)</th>
            <th class="sortable" onclick="sortTable('audio_minutes')">üéôÔ∏è AUDIO (min)</th>
            <th class="sortable" onclick="sortTable('retweets')">üîÑ RTs</th>
            <th class="sortable" onclick="sortTable('likes')">‚ù§Ô∏è LIKES</th>
            <th class="sortable" onclick="sortTable('score')">‚≠ê SCORE</th>
          </tr>
        </thead>
        <tbody id="statsTableBody">
          <tr><td colspan="8" class="loading">Chargement des donn√©es...</td></tr>
        </tbody>
      </table>
    </div>
    
    <pre id="jsonOutput"></pre>
    </div><!-- Fin sectionStats -->
    
    <!-- Section Candidatures -->
    <div class="admin-section" id="sectionCandidatures">
      <div class="header" style="margin-bottom:15px;">üìù CANDIDATURES RE√áUES</div>
      
      <!-- Cr√©ation compte manuel -->
      <div class="message-card" style="background:#e6ffe6;margin-bottom:20px;">
        <div class="message-header">
          <strong style="color:#006400;">‚ûï CR√âER UN COMPTE MANUELLEMENT</strong>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px;">
          <div>
            <label style="color:#000;font-size:11px;">Pseudo de connexion :</label>
            <input type="text" id="manualPseudo" placeholder="pseudo" style="width:100%;padding:5px;font-family:monospace;">
          </div>
          <div>
            <label style="color:#000;font-size:11px;">Mot de passe :</label>
            <input type="text" id="manualPassword" placeholder="mot de passe" style="width:100%;padding:5px;font-family:monospace;">
          </div>
        </div>
        <div style="padding:0 10px 10px;">
          <button onclick="generateManualPassword()" style="padding:5px 10px;margin-right:10px;cursor:pointer;">üé≤ G√©n√©rer MDP</button>
          <button onclick="createManualAccount()" style="padding:5px 15px;background:#006400;color:#fff;border:none;cursor:pointer;font-weight:bold;">‚úÖ CR√âER LE COMPTE</button>
          <span id="manualAccountStatus" style="margin-left:10px;font-size:11px;"></span>
        </div>
      </div>
      
      <div id="candidaturesList">
        <div style="color:#808080;text-align:center;padding:20px;">Chargement...</div>
      </div>
    </div>
    
    <!-- Section Messages Anone -->
    <div class="admin-section" id="sectionAnone">
      <div class="header" style="margin-bottom:15px;">‚úâÔ∏è MESSAGES ANONYMES</div>
      <div id="anoneList">
        <div style="color:#808080;text-align:center;padding:20px;">Chargement...</div>
      </div>
    </div>
    
  </div>
</div>

<script>
// SECRET: brume.mp4
document.getElementById('brumeLink').onclick=()=>{
  const popup=document.createElement('div');
  popup.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000';
  popup.innerHTML='<video src="brume.mp4" controls autoplay style="max-width:80%;max-height:80%"></video>';
  popup.onclick=()=>popup.remove();
  document.body.appendChild(popup);
};

// Cursor
document.addEventListener('DOMContentLoaded', function() {
  const cursor = document.getElementById('cursor');
  document.addEventListener('mousemove', e => {
    cursor.style.left = e.clientX + 'px';
    cursor.style.top = e.clientY + 'px';
  });
});

// Password check (SHA-256 hash of password)
const PASSWORD_HASH = '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08'; // 'test'

async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkPassword() {
  const input = document.getElementById('passwordInput').value;
  const hash = await sha256(input);
  
  if (hash === PASSWORD_HASH) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    loadFromJSON();
  } else {
    document.getElementById('loginError').style.display = 'block';
    document.getElementById('passwordInput').value = '';
  }
}

// Data
let contributors = [];
let currentPeriod = 'y2026';
let sortColumn = 'name';
let sortAsc = true;

// Load from data.json
async function loadFromJSON() {
  try {
    const response = await fetch('data.json');
    const data = await response.json();
    contributors = data.contributors;
    document.getElementById('lastUpdate').textContent = data.lastUpdate || 'N/A';
    initContributorSelect();
    renderTable();
    showStatus('‚úÖ Donn√©es charg√©es depuis data.json', 'success');
  } catch (e) {
    showStatus('‚ùå Erreur de chargement: ' + e.message, 'error');
  }
}

// Calculate score
function calculateScore(data) {
  const books = data.books || 0;
  const articles = data.articles || 0;
  const video = data.video_minutes || 0;
  const audio = data.audio_minutes || 0;
  const rts = data.retweets || 0;
  const likes = data.likes || 0;
  
  return (books * 50) + (articles * 5) + (video * 0.5) + (audio * 0.3) + (rts * 0.5) + (likes * 0.1);
}

// Init contributor select
function initContributorSelect() {
  const select = document.getElementById('contributorSelect');
  select.innerHTML = '<option value="">-- S√©lectionner --</option>';
  contributors.forEach((c, idx) => {
    const option = document.createElement('option');
    option.value = idx;
    option.textContent = c.name;
    select.appendChild(option);
  });
}

// Set period
function setPeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-buttons button').forEach(btn => {
    btn.classList.toggle('active', btn.textContent === period.replace('y', ''));
  });
  renderTable();
}

// Render table
function renderTable() {
  const tbody = document.getElementById('statsTableBody');
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  // Sort contributors
  let sorted = [...contributors];
  sorted.sort((a, b) => {
    let valA, valB;
    if (sortColumn === 'name') {
      valA = a.name.toLowerCase();
      valB = b.name.toLowerCase();
    } else if (sortColumn === 'score') {
      valA = calculateScore(a[currentPeriod] || {});
      valB = calculateScore(b[currentPeriod] || {});
    } else {
      valA = (a[currentPeriod] || {})[sortColumn] || 0;
      valB = (b[currentPeriod] || {})[sortColumn] || 0;
    }
    if (sortAsc) return valA > valB ? 1 : -1;
    return valA < valB ? 1 : -1;
  });
  
  // Filter by search
  if (search) {
    sorted = sorted.filter(c => c.name.toLowerCase().includes(search));
  }
  
  tbody.innerHTML = '';
  
  sorted.forEach((c, idx) => {
    const originalIdx = contributors.indexOf(c);
    const data = c[currentPeriod] || {};
    const score = calculateScore(data);
    
    const tr = document.createElement('tr');
    tr.dataset.idx = originalIdx;
    tr.innerHTML = `
      <td class="name-cell">${c.name}</td>
      <td><input type="number" min="0" value="${data.books || 0}" onchange="updateStat(${originalIdx}, 'books', this.value)"></td>
      <td><input type="number" min="0" value="${data.articles || 0}" onchange="updateStat(${originalIdx}, 'articles', this.value)"></td>
      <td><input type="number" min="0" value="${data.video_minutes || 0}" onchange="updateStat(${originalIdx}, 'video_minutes', this.value)"></td>
      <td><input type="number" min="0" value="${data.audio_minutes || 0}" onchange="updateStat(${originalIdx}, 'audio_minutes', this.value)"></td>
      <td><input type="number" min="0" value="${data.retweets || 0}" onchange="updateStat(${originalIdx}, 'retweets', this.value)"></td>
      <td><input type="number" min="0" value="${data.likes || 0}" onchange="updateStat(${originalIdx}, 'likes', this.value)"></td>
      <td class="score-cell">${score.toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Update stat
function updateStat(contributorIdx, field, value) {
  if (!contributors[contributorIdx][currentPeriod]) {
    contributors[contributorIdx][currentPeriod] = {};
  }
  contributors[contributorIdx][currentPeriod][field] = parseInt(value) || 0;
  renderTable();
}

// Sort table
function sortTable(column) {
  if (sortColumn === column) {
    sortAsc = !sortAsc;
  } else {
    sortColumn = column;
    sortAsc = true;
  }
  renderTable();
}

// Filter table
function filterTable() {
  renderTable();
}

// Scroll to contributor
function scrollToContributor() {
  const idx = document.getElementById('contributorSelect').value;
  if (idx !== '') {
    const row = document.querySelector(`tr[data-idx="${idx}"]`);
    if (row) {
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      row.style.background = '#FFFF00';
      setTimeout(() => row.style.background = '', 2000);
    }
  }
}

// Save data (generates JSON to copy)
function saveData() {
  const output = {
    lastUpdate: new Date().toISOString(),
    contributors: contributors
  };
  
  const json = JSON.stringify(output, null, 2);
  const el = document.getElementById('jsonOutput');
  el.textContent = json;
  el.style.display = 'block';
  
  navigator.clipboard.writeText(json).then(() => {
    showStatus('üìã JSON copi√©! Collez-le dans data.json', 'success');
  }).catch(() => {
    showStatus('üíæ JSON g√©n√©r√© ci-dessous', 'success');
  });
}

// Export JSON
function exportJSON() {
  const output = {
    lastUpdate: new Date().toISOString(),
    contributors: contributors
  };
  
  const json = JSON.stringify(output, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'data.json';
  a.click();
  URL.revokeObjectURL(url);
  
  showStatus('üì• Fichier t√©l√©charg√©!', 'success');
}

// Show status message
function showStatus(message, type) {
  const status = document.getElementById('status');
  status.textContent = message;
  status.style.display = 'block';
  status.style.background = type === 'success' ? '#00FF00' : type === 'warning' ? '#FFD700' : '#FF6666';
  setTimeout(() => status.style.display = 'none', 3000);
}

// =============== ADMIN SECTIONS ===============
const gun = Gun({ peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun'] });
const candidaturesDb = gun.get('vitalism-candidatures-v2');
const anoneDb = gun.get('vitalism-anone-v2');

// Cl√© de chiffrement admin (m√™me que dans candidature.html et anone.html)
const _HwMCAU='dTlWREJ6';
const _guCNQL='T1dlb3Y0';
const _ExlzeW='U0VNc1Zz';
const _whyBtZ='bHVnV1N3';
const _AqybIV='Z1IxN0dR';
const _XTZsru='dUxoZVlQ';
const _XxVpcE='MHU2TQ==';
const _PXKoaKtO=s=>atob(s);
const ADMIN_SECRET=_PXKoaKtO(_HwMCAU+_guCNQL+_ExlzeW+_whyBtZ+_AqybIV+_XTZsru+_XxVpcE);

async function decryptData(encrypted) {
  try {
    const decrypted = await SEA.decrypt(encrypted, ADMIN_SECRET);
    return JSON.parse(decrypted);
  } catch (e) {
    console.error('Erreur d√©chiffrement:', e);
    return null;
  }
}

function showAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById('section' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  if (tab === 'candidatures') loadCandidatures();
  if (tab === 'anone') loadAnoneMessages();
}

async function loadCandidatures() {
  const container = document.getElementById('candidaturesList');
  container.innerHTML = '<div style="color:#808080;text-align:center;padding:20px;">üîì D√©chiffrement en cours...</div>';
  
  const items = [];
  const rawItems = [];
  
  candidaturesDb.map().once((data, key) => {
    if (data && data.encrypted) {
      rawItems.push({ id: key, encrypted: data.encrypted, timestamp: data.timestamp });
    }
  });
  
  // Attendre que les donn√©es soient charg√©es
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  // D√©chiffrer chaque candidature
  for (const raw of rawItems) {
    const decrypted = await decryptData(raw.encrypted);
    if (decrypted) {
      items.push({ ...decrypted, id: raw.id });
    }
  }
  
  if (items.length === 0) {
    container.innerHTML = '<div style="color:#808080;text-align:center;padding:20px;">Aucune candidature</div>';
    return;
  }
  
  items.sort((a, b) => new Date(b.submittedAt || b.timestamp) - new Date(a.submittedAt || a.timestamp));
  
  container.innerHTML = items.map(c => `
    <div class="message-card ${c.status === 'pending' ? 'message-unread' : ''}" id="cand-${c.id}">
      <div class="message-header">
        <strong style="color:#000080;">${escapeHtml(c.name)} ${c.alias ? '("' + escapeHtml(c.alias) + '")' : ''}</strong>
        <span>${new Date(c.submittedAt).toLocaleString('fr-FR')} | ${c.status || 'pending'}</span>
      </div>
      <div style="color:#000;font-size:11px;margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px;">
        <div>üìß ${escapeHtml(c.email || 'N/A')}</div>
        <div>üåç ${escapeHtml(c.country || 'N/A')}</div>
        <div>üê¶ ${escapeHtml(c.socials?.twitter || 'N/A')}</div>
        <div>üìÖ Depuis ${c.startYear || 'N/A'}</div>
        <div>üìö ${c.production?.books || 0} livres</div>
        <div>üìù ${c.production?.articles || 0} articles</div>
        <div>üîê Login: ${escapeHtml(c.login?.pseudo || 'N/A')}</div>
      </div>
      <div class="message-content">${escapeHtml(c.motivation || 'Pas de motivation')}</div>
      ${c.quote ? '<div style="color:#666;font-style:italic;margin-top:5px;font-size:11px;">"' + escapeHtml(c.quote) + '"</div>' : ''}
      <div class="message-actions" style="flex-wrap:wrap;">
        <button onclick="viewCandidature('${c.id}')" style="background:#cce5ff;">üëÅÔ∏è JSON</button>
        <button onclick="acceptCandidature('${c.id}')" style="background:#90EE90;">‚úÖ ACCEPTER</button>
        <button onclick="refuseCandidature('${c.id}')" style="background:#FFB6C1;">‚ùå REFUSER</button>
        <button onclick="mailCandidature('${c.id}', 'accept')">üìß Mail Acceptation</button>
        <button onclick="mailCandidature('${c.id}', 'refuse')">üìß Mail Refus</button>
        <button class="danger" onclick="deleteCandidature('${c.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('candCount').textContent = '(' + items.filter(i => i.status === 'pending').length + ')';
    
    document.getElementById('candCount').textContent = '(' + items.filter(i => i.status === 'pending').length + ')';
  }, 1500);
}

async function loadAnoneMessages() {
  const container = document.getElementById('anoneList');
  container.innerHTML = '<div style="color:#808080;text-align:center;padding:20px;">üîì D√©chiffrement en cours...</div>';
  
  const items = [];
  const rawItems = [];
  
  anoneDb.map().once((data, key) => {
    if (data && data.encrypted) {
      rawItems.push({ id: key, encrypted: data.encrypted, timestamp: data.timestamp });
    }
  });
  
  // Attendre que les donn√©es soient charg√©es
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  // D√©chiffrer chaque message
  for (const raw of rawItems) {
    const decrypted = await decryptData(raw.encrypted);
    if (decrypted) {
      items.push({ ...decrypted, id: raw.id });
    }
  }
  
  if (items.length === 0) {
    container.innerHTML = '<div style="color:#808080;text-align:center;padding:20px;">Aucun message</div>';
    return;
  }
  
  items.sort((a, b) => b.timestamp - a.timestamp);
  
  container.innerHTML = items.map(m => `
    <div class="message-card ${m.status === 'unread' ? 'message-unread' : ''}">
      <div class="message-header">
        <strong style="color:#000080;">HASH: ${m.hash || 'N/A'}</strong>
        <span>${new Date(m.timestamp).toLocaleString('fr-FR')} | üîí Chiffr√©</span>
      </div>
      <div class="message-content">${escapeHtml(m.message)}</div>
      <div class="message-actions">
        <button onclick="markAnoneRead('${m.id}')">‚úì Lu</button>
        <button class="danger" onclick="deleteAnone('${m.id}')">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('anoneCount').textContent = '(' + items.filter(i => i.status === 'unread').length + ')';
}

async function viewCandidature(id) {
  candidaturesDb.get(id).once(async (data) => {
    if (!data || !data.encrypted) return;
    const decrypted = await decryptData(data.encrypted);
    const json = JSON.stringify(decrypted, null, 2);
    const el = document.getElementById('jsonOutput');
    el.textContent = json;
    el.style.display = 'block';
    showAdminTab('stats');
  });
}

// Stocker temporairement les candidatures charg√©es
let loadedCandidatures = {};

// Charger une candidature par ID (avec d√©chiffrement)
async function getCandidature(id, callback) {
  if (loadedCandidatures[id]) {
    callback(loadedCandidatures[id]);
    return;
  }
  candidaturesDb.get(id).once(async (data) => {
    if (data && data.encrypted) {
      const decrypted = await decryptData(data.encrypted);
      if (decrypted) {
        loadedCandidatures[id] = decrypted;
        callback(decrypted);
      }
    }
  });
}

// Accepter une candidature et l'importer dans les contributeurs
function acceptCandidature(id) {
  getCandidature(id, (data) => {
    if (!data) return;
    
    // V√©rifier les identifiants
    if (!data.login || !data.login.pseudo || !data.login.password) {
      alert('‚ö†Ô∏è Cette candidature n\'a pas d\'identifiants de connexion.\nImpossible de cr√©er le compte automatiquement.');
      return;
    }
    
    if (!confirm(`Accepter ${data.name} et cr√©er son compte ?\n\nPseudo: ${data.login.pseudo}`)) return;
    
    // Cr√©er le compte Gun.js
    showStatus('Cr√©ation du compte en cours...', 'info');
    
    const tempGun = Gun({ peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun'] });
    const tempUser = tempGun.user();
    
    tempUser.create(data.login.pseudo, data.login.password, (ack) => {
      if (ack.err && !ack.err.includes('already')) {
        showStatus('‚ùå Erreur cr√©ation compte: ' + ack.err, 'error');
        return;
      }
      
      // Cr√©er le nouveau contributeur avec la structure attendue
      const newContributor = {
        name: data.name,
        file: data.name.toLowerCase().replace(/[^a-z0-9]/g, '') + '.html',
        avatar: data.name.toLowerCase().replace(/[^a-z0-9]/g, '') + '.jpg',
        startYear: data.startYear || new Date().getFullYear(),
        country: data.country || 'FR',
        type: 'Contributeur',
        description: '',
        alias: data.alias || '',
        socials: {
          twitter: data.socials?.twitter || null,
          substack: data.socials?.substack || null,
          website: data.socials?.website || null
        },
        radar: data.radar || {
          raisonnement: 50,
          ethique: 50,
          logique: 50,
          esthetique: 50,
          metaphysique: 50,
          sociologie: 50
        },
        quotes: data.quote ? [data.quote] : [],
        books: [],
        articles: [],
        videos: [],
        audio: [],
        translations: [],
        y2018: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2019: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2020: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2021: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2022: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2023: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2024: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2025: { books: 0, articles: 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 },
        y2026: { books: data.production?.books || 0, articles: data.production?.articles || 0, retweets: 0, likes: 0, video_minutes: 0, audio_minutes: 0 }
      };
      
      // Ajouter aux contributeurs
      contributors.push(newContributor);
      
      // Mettre √† jour le statut de la candidature
      candidaturesDb.get(id).get('status').put('accepted');
      
      // Rafra√Æchir l'interface
      initContributorSelect();
      renderTable();
      showStatus(`‚úÖ ${data.name} accept√© ! Compte cr√©√© (${data.login.pseudo}). N'oubliez pas de sauvegarder et exporter le JSON.`, 'success');
      
      // Rafra√Æchir la liste des candidatures
      setTimeout(loadCandidatures, 500);
    });
  });
}

// Refuser une candidature
function refuseCandidature(id) {
  getCandidature(id, (data) => {
    if (!data) return;
    
    const reason = prompt(`Raison du refus pour ${data.name} (optionnel):`);
    if (reason === null) return; // Annul√©
    
    candidaturesDb.get(id).get('status').put('refused');
    candidaturesDb.get(id).get('refuseReason').put(reason || 'Non sp√©cifi√©e');
    
    showStatus(`‚ùå Candidature de ${data.name} refus√©e`, 'warning');
    setTimeout(loadCandidatures, 500);
  });
}

// Envoyer un mail
function mailCandidature(id, type) {
  getCandidature(id, (data) => {
    if (!data || !data.email) {
      alert('Pas d\'email pour ce candidat');
      return;
    }
    
    let subject, body;
    
    if (type === 'accept') {
      subject = encodeURIComponent('Vitalism - Candidature accept√©e');
      const loginInfo = data.login ? `

Vos identifiants de connexion :
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Pseudo : ${data.login.pseudo}
Mot de passe : (celui que vous avez choisi lors de votre candidature)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Connectez-vous sur : [URL du site]/auth.html` : '';
      
      body = encodeURIComponent(`Bonjour ${data.name},

Nous avons le plaisir de vous informer que votre candidature pour rejoindre Vitalism a √©t√© accept√©e !

Bienvenue dans la communaut√©.
${loginInfo}

Vous pouvez d√©sormais acc√©der au forum et √† la chatbox.

√Ä tr√®s bient√¥t,
L'√©quipe Vitalism`);
    } else {
      subject = encodeURIComponent('Vitalism - Candidature');
      body = encodeURIComponent(`Bonjour ${data.name},

Nous vous remercions de l'int√©r√™t que vous portez √† Vitalism.

Apr√®s examen de votre candidature, nous ne sommes malheureusement pas en mesure de l'accepter pour le moment.

N'h√©sitez pas √† renouveler votre demande ult√©rieurement si vous le souhaitez.

Cordialement,
L'√©quipe Vitalism`);
    }
    
    window.open(`mailto:${data.email}?subject=${subject}&body=${body}`, '_blank');
  });
}

function markCandidatureRead(id) {
  candidaturesDb.get(id).get('status').put('read');
  setTimeout(loadCandidatures, 500);
}

function deleteCandidature(id) {
  if (confirm('Supprimer cette candidature ?')) {
    candidaturesDb.get(id).put(null);
    setTimeout(loadCandidatures, 500);
  }
}

function markAnoneRead(id) {
  anoneDb.get(id).get('status').put('read');
  setTimeout(loadAnoneMessages, 500);
}

function deleteAnone(id) {
  if (confirm('Supprimer ce message ?')) {
    anoneDb.get(id).put(null);
    setTimeout(loadAnoneMessages, 500);
  }
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// =============== CR√âATION COMPTE MANUEL ===============
function generateManualPassword() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%&*';
  let password = '';
  for (let i = 0; i < 16; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  document.getElementById('manualPassword').value = password;
}

function createManualAccount() {
  const pseudo = document.getElementById('manualPseudo').value.trim();
  const password = document.getElementById('manualPassword').value;
  const status = document.getElementById('manualAccountStatus');
  
  if (!pseudo || pseudo.length < 3) {
    status.innerHTML = '<span style="color:red;">‚ùå Pseudo trop court (min 3 car.)</span>';
    return;
  }
  
  if (!password || password.length < 6) {
    status.innerHTML = '<span style="color:red;">‚ùå Mot de passe trop court (min 6 car.)</span>';
    return;
  }
  
  if (!/^[a-zA-Z0-9_-]+$/.test(pseudo)) {
    status.innerHTML = '<span style="color:red;">‚ùå Pseudo invalide (lettres, chiffres, - _ uniquement)</span>';
    return;
  }
  
  status.innerHTML = '<span style="color:blue;">‚è≥ Cr√©ation en cours...</span>';
  
  // Cr√©er le compte Gun.js
  const tempGun = Gun({ peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun'] });
  const tempUser = tempGun.user();
  
  tempUser.create(pseudo, password, (ack) => {
    if (ack.err) {
      if (ack.err.includes('already')) {
        status.innerHTML = '<span style="color:orange;">‚ö†Ô∏è Ce pseudo existe d√©j√†</span>';
      } else {
        status.innerHTML = '<span style="color:red;">‚ùå Erreur: ' + ack.err + '</span>';
      }
    } else {
      status.innerHTML = '<span style="color:green;">‚úÖ Compte cr√©√© ! Pseudo: <strong>' + pseudo + '</strong></span>';
      
      // Copier les infos dans le presse-papier
      const infos = `Pseudo: ${pseudo}\nMot de passe: ${password}`;
      navigator.clipboard.writeText(infos).then(() => {
        status.innerHTML += ' (copi√© !)';
      });
      
      // Vider les champs
      document.getElementById('manualPseudo').value = '';
      document.getElementById('manualPassword').value = '';
    }
  });
}

// Charger les compteurs au d√©marrage
setTimeout(() => {
  let candCount = 0, anoneCount = 0;
  candidaturesDb.map().once((d) => { if (d && d.status === 'pending') candCount++; });
  anoneDb.map().once((d) => { if (d && d.status === 'unread') anoneCount++; });
  setTimeout(() => {
    document.getElementById('candCount').textContent = candCount > 0 ? '(' + candCount + ')' : '';
    document.getElementById('anoneCount').textContent = anoneCount > 0 ? '(' + anoneCount + ')' : '';
  }, 1000);
}, 1000);
</script>
</body>
</html>
