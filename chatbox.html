<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
<title>Chatbox Vitalism</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
@keyframes flicker{0%,100%{opacity:1}50%{opacity:0.97}}
@keyframes scanline{0%{transform:translateY(-100%)}100%{transform:translateY(100vh)}}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  background: #0000AA;
  color: #fff;
  font-family: "Courier New", monospace;
  animation: flicker 0.15s infinite;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 2px;
  background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
  animation: scanline 8s linear infinite;
  pointer-events: none;
  z-index: 1000;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

.logo {
  border: 2px solid #fff;
  display: inline-block;
  padding: 4px 16px;
  margin-bottom: 20px;
  text-decoration: none;
  color: #fff;
}
.logo span { background: #fff; color: #0000AA; padding: 0 4px; font-weight: bold; }
.logo:hover { background: #fff; }

h1 {
  font-size: 24px;
  margin-bottom: 10px;
  text-shadow: 2px 2px 0 #000;
}

.subtitle {
  font-size: 12px;
  color: #aaa;
  margin-bottom: 20px;
}

.chat-window {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  box-shadow: 4px 4px 0 #000;
}

.chat-header {
  background: linear-gradient(90deg, #000080, #1084d0);
  color: #fff;
  padding: 4px 8px;
  font-weight: bold;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-status {
  font-size: 10px;
  color: #0f0;
}

.chat-messages {
  height: 400px;
  overflow-y: auto;
  background: #fff;
  border: 2px inset #808080;
  margin: 8px;
  padding: 10px;
  font-size: 13px;
  color: #000;
}

.message {
  margin-bottom: 8px;
  padding: 5px;
  border-radius: 3px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message .time {
  color: #808080;
  font-size: 10px;
  margin-right: 5px;
}

.message .username {
  font-weight: bold;
  margin-right: 5px;
}

.message.self {
  background: #e8f4ff;
}

.message.system {
  color: #808080;
  font-style: italic;
  text-align: center;
  font-size: 11px;
}

.chat-input-area {
  padding: 8px;
  display: flex;
  gap: 8px;
}

.chat-input {
  flex: 1;
  padding: 6px 10px;
  font-family: "Courier New", monospace;
  font-size: 13px;
  border: 2px inset #808080;
}

.chat-send {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 6px 20px;
  font-family: "Courier New", monospace;
  font-weight: bold;
  cursor: pointer;
}

.chat-send:hover { background: #d4d4d4; }

.chat-send:active {
  border-color: #808080 #fff #fff #808080;
}

.username-setup {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 4px 4px 0 #000;
}

.username-setup label {
  color: #000;
  font-weight: bold;
  display: block;
  margin-bottom: 10px;
}

.username-setup input {
  padding: 6px 10px;
  font-family: "Courier New", monospace;
  font-size: 13px;
  border: 2px inset #808080;
  width: 200px;
  margin-right: 10px;
}

.online-users {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 10px;
  margin-top: 20px;
  box-shadow: 4px 4px 0 #000;
}

.online-users h3 {
  color: #000;
  font-size: 12px;
  margin: 0 0 10px 0;
}

.online-list {
  color: #000;
  font-size: 11px;
}

.online-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: #0f0;
  border-radius: 50%;
  margin-right: 5px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.info-box {
  background: rgba(255,255,255,0.1);
  border: 1px solid #fff;
  padding: 10px;
  margin-top: 20px;
  font-size: 11px;
}

.info-box h4 {
  margin: 0 0 5px 0;
  color: #ff0;
}
</style>
</head>
<body>

<div class="container">
  <a href="borne.html" class="logo"><span>:vitalism</span></a>
  
  <h1>üí¨ CHATBOX VITALISM</h1>
  <p class="subtitle">Communication d√©centralis√©e P2P - Aucun serveur central</p>
  
  <div class="username-setup" id="usernameSetup">
    <label>‚ö° Choisis ton pseudo pour rejoindre le chat :</label>
    <input type="text" id="usernameInput" placeholder="Ton pseudo..." maxlength="20">
    <button class="chat-send" onclick="setUsername()">Rejoindre</button>
  </div>
  
  <div class="chat-window" id="chatWindow" style="display:none;">
    <div class="chat-header">
      <span>üì° Chat Vitalism - R√©seau P2P</span>
      <span class="chat-status" id="chatStatus">‚óè Connect√©</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message system">Bienvenue dans la chatbox d√©centralis√©e !</div>
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="messageInput" placeholder="√âcris ton message..." maxlength="500" onkeypress="if(event.key==='Enter')sendMessage()">
      <button class="chat-send" onclick="sendMessage()">Envoyer</button>
    </div>
  </div>
  
  <div class="online-users" id="onlineUsers" style="display:none;">
    <h3>üë• Utilisateurs en ligne</h3>
    <div class="online-list" id="onlineList">
      <span class="online-dot"></span> Chargement...
    </div>
  </div>
  
  <div class="info-box">
    <h4>üîí Comment √ßa marche ?</h4>
    <p>Cette chatbox utilise Gun.js, un protocole d√©centralis√© peer-to-peer.<br>
    Les messages se synchronisent directement entre les navigateurs des utilisateurs.<br>
    Aucune donn√©e n'est stock√©e sur un serveur central. Aucun tracking.</p>
  </div>
</div>

<script>
// Initialiser Gun avec des relais publics
const gun = Gun({
  peers: [
    'https://gun-manhattan.herokuapp.com/gun',
    'https://gun-us.herokuapp.com/gun'
  ]
});

const chat = gun.get('vitalism-chatbox-v1');
const users = gun.get('vitalism-users-v1');

let myUsername = '';
let myId = 'user_' + Math.random().toString(36).substr(2, 9);
let displayedMessages = new Set();

function setUsername() {
  const input = document.getElementById('usernameInput');
  const name = input.value.trim();
  
  if (name.length < 2) {
    alert('Pseudo trop court (min 2 caract√®res)');
    return;
  }
  
  myUsername = name;
  localStorage.setItem('vitalism-username', name);
  
  document.getElementById('usernameSetup').style.display = 'none';
  document.getElementById('chatWindow').style.display = 'block';
  document.getElementById('onlineUsers').style.display = 'block';
  
  // Annoncer sa pr√©sence
  users.get(myId).put({
    name: myUsername,
    online: true,
    lastSeen: Date.now()
  });
  
  // Message syst√®me
  addSystemMessage(myUsername + ' a rejoint le chat');
  
  // Envoyer un message de join
  chat.get('msg_' + Date.now() + '_' + myId).put({
    type: 'join',
    username: myUsername,
    time: Date.now()
  });
  
  // Charger les messages existants
  loadMessages();
  
  // √âcouter les nouveaux messages
  listenForMessages();
  
  // Mettre √† jour la liste des utilisateurs
  updateOnlineUsers();
  
  // Heartbeat pour rester en ligne
  setInterval(() => {
    users.get(myId).put({
      name: myUsername,
      online: true,
      lastSeen: Date.now()
    });
  }, 30000);
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  const msgId = 'msg_' + Date.now() + '_' + myId;
  
  chat.get(msgId).put({
    type: 'message',
    username: myUsername,
    text: text,
    time: Date.now(),
    userId: myId
  });
  
  input.value = '';
}

function loadMessages() {
  // Charger les messages des derni√®res 24h
  const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
  
  chat.map().once((data, key) => {
    if (data && data.time && data.time > oneDayAgo) {
      displayMessage(data, key);
    }
  });
}

function listenForMessages() {
  chat.map().on((data, key) => {
    if (data && data.time) {
      displayMessage(data, key);
    }
  });
}

function displayMessage(data, key) {
  if (displayedMessages.has(key)) return;
  displayedMessages.add(key);
  
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  
  const time = new Date(data.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  
  if (data.type === 'join') {
    div.className = 'message system';
    div.textContent = data.username + ' a rejoint le chat';
  } else if (data.type === 'leave') {
    div.className = 'message system';
    div.textContent = data.username + ' a quitt√© le chat';
  } else {
    div.className = 'message' + (data.userId === myId ? ' self' : '');
    div.innerHTML = `
      <span class="time">[${time}]</span>
      <span class="username" style="color:${stringToColor(data.username)}">${escapeHtml(data.username)}:</span>
      <span class="text">${escapeHtml(data.text)}</span>
    `;
  }
  
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addSystemMessage(text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'message system';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function updateOnlineUsers() {
  const list = document.getElementById('onlineList');
  const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
  let html = '';
  let count = 0;
  
  users.map().once((data, key) => {
    if (data && data.online && data.lastSeen > fiveMinutesAgo) {
      count++;
      html += `<div><span class="online-dot"></span> ${escapeHtml(data.name)}</div>`;
    }
  });
  
  setTimeout(() => {
    if (count === 0) {
      list.innerHTML = '<div><span class="online-dot"></span> ' + myUsername + ' (toi)</div>';
    } else {
      list.innerHTML = html;
    }
  }, 1000);
  
  // Rafra√Æchir toutes les 30 secondes
  setTimeout(updateOnlineUsers, 30000);
}

function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const hue = hash % 360;
  return `hsl(${hue}, 70%, 35%)`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Charger le pseudo sauvegard√©
window.onload = function() {
  const saved = localStorage.getItem('vitalism-username');
  if (saved) {
    document.getElementById('usernameInput').value = saved;
  }
};

// Signaler le d√©part
window.onbeforeunload = function() {
  users.get(myId).put({
    name: myUsername,
    online: false,
    lastSeen: Date.now()
  });
};
</script>

</body>
</html>
