<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230000AA%22>:v</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230000AA%22>:v</text></svg>">
<title>CH@TB0X.EXE</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
<style>
@keyframes flicker{0%,100%{opacity:1}50%{opacity:0.97}}
@keyframes scanline{0%{transform:translateY(-100%)}100%{transform:translateY(100vh)}}

* { box-sizing: border-box; }

body {
  margin: 0;
  padding: 20px;
  min-height: 100vh;
  background: #0000AA;
  color: #fff;
  font-family: "Courier New", monospace;
  animation: flicker 0.15s infinite;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 2px;
  background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
  animation: scanline 8s linear infinite;
  pointer-events: none;
  z-index: 1000;
}

.container { max-width: 900px; margin: 0 auto; }

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.logo {
  border: 2px solid #fff;
  display: inline-block;
  padding: 4px 16px;
  text-decoration: none;
  color: #fff;
}
.logo span { background: #fff; color: #0000AA; padding: 0 4px; font-weight: bold; }
.logo:hover { background: #fff; }

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
  background: rgba(255,255,255,0.1);
  padding: 8px 15px;
  border: 1px solid #fff;
}
.user-info .username { color: #0f0; font-weight: bold; }
.user-info a { color: #ff0; text-decoration: none; font-size: 12px; }
.user-info a:hover { text-decoration: underline; }

h1 { font-size: 24px; margin-bottom: 5px; text-shadow: 2px 2px 0 #000; }
.subtitle { font-size: 12px; color: #aaa; margin-bottom: 20px; }

.main-layout { display: flex; gap: 20px; }
.chat-section { flex: 1; }
.sidebar { width: 200px; }

.chat-window {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  box-shadow: 4px 4px 0 #000;
}

.chat-header {
  background: linear-gradient(90deg, #000080, #1084d0);
  color: #fff;
  padding: 4px 8px;
  font-weight: bold;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
}

.chat-status { font-size: 10px; color: #0f0; }

.chat-messages {
  height: 450px;
  overflow-y: auto;
  background: #fff;
  border: 2px inset #808080;
  margin: 8px;
  padding: 10px;
  font-size: 13px;
  color: #000;
}

.message {
  margin-bottom: 8px;
  padding: 5px;
  border-radius: 3px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message .time { color: #808080; font-size: 10px; margin-right: 5px; }
.message .username { font-weight: bold; margin-right: 5px; }
.message .verified { color: #0a0; font-size: 10px; }
.message.self { background: #e8f4ff; }
.message.system { color: #808080; font-style: italic; text-align: center; font-size: 11px; }

.chat-input-area { padding: 8px; display: flex; gap: 8px; }
.chat-input {
  flex: 1;
  padding: 6px 10px;
  font-family: "Courier New", monospace;
  font-size: 13px;
  border: 2px inset #808080;
}

.chat-send {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 6px 20px;
  font-family: "Courier New", monospace;
  font-weight: bold;
  cursor: pointer;
}
.chat-send:hover { background: #d4d4d4; }
.chat-send:active { border-color: #808080 #fff #fff #808080; }

.online-users {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 10px;
  box-shadow: 4px 4px 0 #000;
  margin-bottom: 15px;
}
.online-users h3 {
  color: #000;
  font-size: 12px;
  margin: 0 0 10px 0;
  padding-bottom: 5px;
  border-bottom: 1px solid #808080;
}
.online-list { color: #000; font-size: 11px; max-height: 200px; overflow-y: auto; }
.online-item { padding: 3px 0; }
.online-dot {
  display: inline-block;
  width: 8px; height: 8px;
  background: #0f0;
  border-radius: 50%;
  margin-right: 5px;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

.info-box {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 10px;
  box-shadow: 4px 4px 0 #000;
}
.info-box h4 { margin: 0 0 5px 0; color: #000080; font-size: 11px; }
.info-box p { color: #000; font-size: 10px; margin: 0; line-height: 1.4; }

.auth-required {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
  padding: 30px;
  text-align: center;
  box-shadow: 4px 4px 0 #000;
}
.auth-required h2 { color: #000080; margin: 0 0 15px 0; }
.auth-required p { color: #000; margin-bottom: 20px; }
.auth-required a {
  display: inline-block;
  padding: 10px 30px;
  background: #000080;
  color: #fff;
  text-decoration: none;
  font-weight: bold;
  border: 2px solid;
  border-color: #fff #808080 #808080 #fff;
}
.auth-required a:hover { background: #0000AA; }

@media (max-width: 768px) {
  .main-layout { flex-direction: column; }
  .sidebar { width: 100%; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <a href="menu.html" class="logo"><span>:vitalism</span></a>
    <div class="user-info" id="userInfo" style="display:none;">
      <span>Connect√© : <span class="username" id="currentUser"></span></span>
      <a href="#" onclick="logout()">D√©connexion</a>
    </div>
  </div>
  
  
  <!-- Non connect√© -->
  <div id="authRequired" class="auth-required">
    <h2>üîê Connexion requise</h2>
    <p>Vous devez √™tre connect√© pour acc√©der √† la chatbox.<br>
    L'authentification garantit que personne ne peut usurper votre identit√©.</p>
    <a href="auth.html?redirect=chatbox.html">Se connecter / S'inscrire</a>
  </div>
  
  <!-- Connect√© -->
  <div id="chatArea" style="display:none;">
    <div class="main-layout">
      <div class="chat-section">
        <div class="chat-window">
          <div class="chat-header">
            <span>üì° Chat Vitalism - R√©seau P2P S√©curis√©</span>
            <span class="chat-status">‚óè Connect√©</span>
          </div>
          <div class="chat-messages" id="chatMessages">
            <div class="message system">Bienvenue dans la chatbox d√©centralis√©e s√©curis√©e !</div>
          </div>
          <div class="chat-input-area">
            <input type="text" class="chat-input" id="messageInput" placeholder="√âcris ton message..." maxlength="500" onkeypress="if(event.key==='Enter')sendMessage()">
            <button class="chat-send" onclick="sendMessage()">Envoyer</button>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="online-users">
          <h3>üë• En ligne</h3>
          <div class="online-list" id="onlineList">Chargement...</div>
        </div>
        
        <div class="info-box">
          <h4>üîí S√©curit√©</h4>
          <p>‚úì Messages sign√©s<br>‚úì Identit√© v√©rifiable<br>‚úì D√©centralis√© P2P</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const gun = Gun({ peers: ['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun'] });
const user = gun.user().recall({ sessionStorage: true });
const chat = gun.get('vitalism-chat-v2');
const presence = gun.get('vitalism-presence-v2');

let myUsername = '', myPub = '';
let displayedMessages = new Set();

gun.on('auth', () => initChat());
setTimeout(() => { if (user.is) initChat(); }, 500);

function initChat() {
  myUsername = user.is.alias;
  myPub = user.is.pub;
  
  document.getElementById('authRequired').style.display = 'none';
  document.getElementById('chatArea').style.display = 'block';
  document.getElementById('userInfo').style.display = 'flex';
  document.getElementById('currentUser').textContent = myUsername;
  
  updatePresence();
  setInterval(updatePresence, 30000);
  loadMessages();
  updateOnlineList();
  setInterval(updateOnlineList, 10000);
  addSystemMessage('üîí Connect√© en mode chiffr√© : ' + myUsername);
}

// Cl√© de chiffrement groupe (partag√©e entre tous les membres)
const _RMsWci='MzRQWmFo';
const _MjDhWz='azZ5MElD';
const _YyKJXr='WmlweFo5';
const _fMzBgo='ZzJHdVlC';
const _HSOGzM='UjNkNWRH';
const _iAUzoh='UTBvUEVE';
const _boqGpx='ZlNCNg==';
const _zjgIlDZR=s=>atob(s);
const GROUP_KEY=_zjgIlDZR(_RMsWci+_MjDhWz+_YyKJXr+_fMzBgo+_HSOGzM+_iAUzoh+_boqGpx);

function updatePresence() {
  if (!user.is) return;
  presence.get(myPub).put({ username: myUsername, pub: myPub, online: true, lastSeen: Date.now() });
}

async function sendMessage() {
  if (!user.is) return;
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  
  const msgData = { text, username: myUsername, pub: myPub, time: Date.now() };
  
  // Chiffrer le message pour le groupe
  const encryptedText = await SEA.encrypt(text, GROUP_KEY);
  const encryptedData = { encryptedText, username: myUsername, pub: myPub, time: Date.now() };
  
  // Signer le message chiffr√©
  SEA.sign(encryptedData, user._.sea).then(signed => {
    chat.get('msg_' + Date.now() + '_' + myPub.slice(0, 8)).put({ signed, pub: myPub });
  });
  input.value = '';
}

function loadMessages() {
  chat.map().on(async (data, key) => {
    if (!data || !data.signed || displayedMessages.has(key)) return;
    displayedMessages.add(key);
    
    const verified = await SEA.verify(data.signed, data.pub);
    if (verified && Date.now() - verified.time < 24 * 60 * 60 * 1000) {
      // D√©chiffrer le message
      let text = verified.text; // Ancien format non chiffr√©
      if (verified.encryptedText) {
        text = await SEA.decrypt(verified.encryptedText, GROUP_KEY);
      }
      if (text) {
        displayMessage({ ...verified, text }, data.pub);
      }
    }
  });
}

function displayMessage(msg, pub) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  const time = new Date(msg.time).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  
  div.className = 'message' + (pub === myPub ? ' self' : '');
  div.innerHTML = `<span class="time">[${time}]</span><span class="username" style="color:${stringToColor(msg.username)}">${escapeHtml(msg.username)}</span><span class="verified">‚úì</span> ${escapeHtml(msg.text)}`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addSystemMessage(text) {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'message system';
  div.textContent = text;
  container.appendChild(div);
}

function updateOnlineList() {
  const list = document.getElementById('onlineList');
  const cutoff = Date.now() - 5 * 60 * 1000;
  const users = [];
  
  presence.map().once((data) => {
    if (data && data.online && data.lastSeen > cutoff) users.push({ name: data.username, isSelf: data.pub === myPub });
  });
  
  setTimeout(() => {
    list.innerHTML = users.length ? users.map(u => `<div class="online-item"><span class="online-dot"></span>${escapeHtml(u.name)}${u.isSelf ? ' (vous)' : ''}</div>`).join('') : `<div class="online-item"><span class="online-dot"></span>${myUsername} (vous)</div>`;
  }, 500);
}

function logout() {
  presence.get(myPub).put({ online: false, lastSeen: Date.now() });
  user.leave();
  location.href = 'auth.html';
}

function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
  return `hsl(${hash % 360}, 70%, 35%)`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

window.onbeforeunload = () => { if (user.is) presence.get(myPub).put({ online: false, lastSeen: Date.now() }); };
</script>
</body>
</html>
