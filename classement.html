<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%230000AA%22>:v</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CL@SS_Œ£500</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text x='16' y='24' font-family='Courier New' font-size='20' font-weight='bold' fill='%230000AA' text-anchor='middle'>:V</text></svg>">
<style>
@keyframes blink { 0%,49%{opacity:1;}50%,100%{opacity:0;} }
@keyframes flicker { 0%,100%{opacity:1;}50%{opacity:0.96;} }
@keyframes scanline { 0%{transform:translateY(-100%);}100%{transform:translateY(100vh);} }

* { cursor: none !important; box-sizing: border-box; }

body {
  background-color: #0000AA;
  color: #FFFFFF;
  font-family: "Courier New", monospace;
  font-size:16px;
  margin:0;
  padding:40px 20px;
  min-height:100vh;
  animation: flicker 0.15s infinite;
  text-shadow:0 0 2px rgba(255,255,255,0.5);
  position: relative;
  overflow-y: auto;
}

body::before {
  content: '';
  position:fixed;
  top:0; left:0; width:100%; height:2px;
  background: linear-gradient(transparent, rgba(255,255,255,0.1), transparent);
  animation: scanline 8s linear infinite;
  pointer-events:none; z-index:1000;
}

body::after {
  content:'';
  position:fixed; top:0; left:0; right:0; bottom:0;
  background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
  pointer-events:none; z-index:999;
}

.content { position: relative; z-index:1; max-width:1400px; margin:0 auto; }

.logo {

  border: 2px solid #FFFFFF;
  display: inline-block;
  padding: 4px 16px;
  margin-bottom: 30px;
  cursor: pointer;
  transition: all 0.2s;
}
.logo:hover { background: #FFFFFF; }

.tabs-container {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #FFFFFF #808080 #808080 #FFFFFF;
  margin-bottom: 30px;
  box-shadow: 4px 4px 0 #000000;
}

.tabs-header {
  display: flex;
  background: #808080;
  border-bottom: 2px solid #000000;
}

.tab-btn {
  flex: 1;
  padding: 15px 20px;
  background: #C0C0C0;
  border: none;
  border-right: 2px solid #000000;
  color: #000000;
  font-weight: bold;
  font-family: "Courier New", monospace;
  font-size: 14px;
  cursor: pointer;
}
.tab-btn:hover { background: #DFDFDF; }
.tab-btn.active {
  background: #C0C0C0;
  border-bottom: 2px solid #C0C0C0;
  margin-bottom: -2px;
  border-top: 2px solid #FFFFFF;
}

.tab-content { display: none; padding: 20px; }
.tab-content.active { display: block; }

.period-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  align-items: center;
  flex-wrap: wrap;
}

.control-label {
  font-size: 14px;
  color: #000000;
  font-weight: bold;
}

.period-select {
  padding: 8px 16px;
  border: 2px solid;
  border-color: #FFFFFF #808080 #808080 #FFFFFF;
  background: #E0E0E0;
  color: #000000;
  font-weight: bold;
  cursor: pointer;
  font-family: "Courier New", monospace;
  font-size: 13px;
  min-width: 200px;
}
.period-select:hover { background: #F0F0F0; }
.period-select:focus {
  outline: none;
  border-color: #000080;
}
.period-select option {
  background: #FFFFFF;
  color: #000000;
  padding: 5px;
}
.period-select optgroup {
  background: #C0C0C0;
  color: #000080;
  font-weight: bold;
}

.period-btn {
  padding: 8px 16px;
  border: 2px solid;
  border-color: #FFFFFF #808080 #808080 #FFFFFF;
  background: #E0E0E0;
  color: #000000;
  font-weight: bold;
  cursor: pointer;
  font-family: "Courier New", monospace;
  font-size: 12px;
}
.period-btn:hover { background: #F0F0F0; }
.period-btn.active {
  background: #C0C0C0;
  border-color: #808080 #FFFFFF #FFFFFF #808080;
  box-shadow: inset 1px 1px 2px #000000;
}

/* Podium */
.podium-section {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 20px;
  min-height: 180px;
}

.podium-card {
  background: #C0C0C0;
  border: 2px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  padding: 12px;
  text-align: center;
  box-shadow: 2px 2px 0 #000000;
}
.podium-card.rank-1 { background: #FFD700; }
.podium-card.rank-2 { background: #E8E8E8; }
.podium-card.rank-3 { background: #CD7F32; }

.podium-rank { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
.podium-name { font-size: 14px; font-weight: bold; color: #000000; margin-bottom: 5px; }
.podium-score { font-size: 18px; font-weight: bold; color: #000000; margin-bottom: 8px; }
.podium-stats { font-size: 10px; color: #000000; line-height: 1.4; margin-top: 5px; padding-top: 5px; border-top: 1px solid #808080; }

.podium-view-btn {
  margin-top: 8px;
  padding: 4px 12px;
  border: 2px solid;
  border-color: #FFFFFF #808080 #808080 #FFFFFF;
  background: #000080;
  color: #FFFFFF;
  font-weight: bold;
  cursor: pointer;
  font-family: "Courier New", monospace;
  font-size: 10px;
  text-decoration: none;
  display: inline-block;
}
.podium-view-btn:hover { background: #0000FF; }

/* Table */
.ranking-table-container {
  background: #FFFFFF;
  padding: 2px;
  margin-bottom: 30px;
  overflow-x: auto;
}

table { border-collapse: collapse; width: 100%; background-color: #FFFFFF; table-layout: fixed; }
th, td { border: 1px solid #C0C0C0; padding: 10px 8px; text-align: center; color: #000000; overflow: hidden; text-overflow: ellipsis; }
th { 
  background: #000080; 
  color: #FFFFFF; 
  font-weight: bold; 
  cursor: pointer;
  white-space: nowrap;
  position: relative;
}
th:hover { background: #0000FF; }
th.sorted-asc, th.sorted-desc { background: #000060; }
th .sort-arrow { margin-left: 5px; font-size: 10px; }
th .sort-arrow.asc::after { content: '‚ñ≤'; color: #FFD700; }
th .sort-arrow.desc::after { content: '‚ñº'; color: #FFD700; }

/* Largeurs fixes des colonnes */
th:nth-child(1), td:nth-child(1) { width: 60px; }  /* RANG */
th:nth-child(2), td:nth-child(2) { width: 180px; } /* NOM */
th:nth-child(3), td:nth-child(3) { width: 80px; }  /* Livres */
th:nth-child(4), td:nth-child(4) { width: 80px; }  /* Traductions */
th:nth-child(5), td:nth-child(5) { width: 60px; }  /* Articles */
th:nth-child(6), td:nth-child(6) { width: 60px; }  /* Vid√©os */
th:nth-child(7), td:nth-child(7) { width: 100px; } /* SCORE */
th:nth-child(8), td:nth-child(8) { width: 150px; } /* BADGES */
th:nth-child(9), td:nth-child(9) { width: 80px; }  /* ACTION */

tr:nth-child(even) td { background-color: #F0F0F0; }
tr:nth-child(odd) td { background-color: #FFFFFF; }
tr:hover td { background-color: #FFFFCC !important; }

a.contributor-link {
  color: #000080;
  text-decoration: none;
  font-weight: bold;
  border-bottom: 2px dotted #000080;
}
a.contributor-link:hover { color: #0000FF; }

.badge {
  background: #FFD700;
  color: #000000;
  padding: 3px 6px;
  font-size: 9px;
  border: 1px solid #000000;
  font-weight: bold;
  display: inline-block;
  margin: 1px;
}
.badge.silver { background: #C0C0C0; }
.badge.bronze { background: #CD7F32; color: #FFFFFF; }

.score-cell { font-weight: bold; font-size: 14px; }

.view-btn {
  padding: 5px 12px;
  border: 2px solid;
  border-color: #FFFFFF #808080 #808080 #FFFFFF;
  background: #C0C0C0;
  color: #000000;
  font-weight: bold;
  cursor: pointer;
  font-family: "Courier New", monospace;
  font-size: 10px;
  text-decoration: none;
}
.view-btn:hover { background: #000080; color: #FFFFFF; }

/* Stats */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.stat-card {
  background: #C0C0C0;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  padding: 20px;
  text-align: center;
  box-shadow: 4px 4px 0 #000000;
}
.stat-icon { font-size: 28px; margin-bottom: 8px; }
.stat-value { font-size: 28px; font-weight: bold; color: #000080; margin-bottom: 5px; }
.stat-label { font-size: 11px; color: #000000; font-weight: bold; }

/* Footer */
.footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: #C0C0C0;
  border: 3px solid;
  border-color: #FFFFFF #000000 #000000 #FFFFFF;
  color: #000000;
  box-shadow: 4px 4px 0 #000000;
}
.footer-title { color: #FF0000; font-weight: bold; font-size: 14px; margin-bottom: 10px; }
.footer-info { font-size: 11px; line-height: 1.6; }
.blink-cursor { display: inline-block; width: 8px; height: 14px; background-color: #000000; animation: blink 1s infinite; margin-left: 3px; vertical-align: middle; }

.custom-cursor { position: fixed; width: 16px; height: 16px; background-color: #FFFFFF; pointer-events: none; z-index: 10000; mix-blend-mode: difference; display: none; }
body:hover .custom-cursor { display: block; }

@media (max-width: 768px) {
  .podium-section { grid-template-columns: 1fr; }
  .tabs-header { flex-direction: column; }
  table { font-size: 11px; }
  th, td { padding: 6px 4px; }
}
</style>
</head>
<body>
<div class="custom-cursor" id="cursor"></div>

<div class="content">
  <a href="borne.html" style="text-decoration:none;">
    <div class="logo"><span>:vitalism</span></div>
  </a>

  <div style="font-size:12px; color:#AAAAAA; margin-bottom:20px;">
    A fatal exception 0xVIT has occurred at 0028:C00NTRIB in VXD BLUEJEANISM(01)<br>
    Press any key to view rankings_
  </div>

  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-btn active" onclick="switchTab('current')">üìä CLASSEMENT ACTUEL</button>
      <button class="tab-btn" onclick="switchTab('history')">üìÖ HISTORIQUE</button>
      <button class="tab-btn" onclick="switchTab('stats')">üìà STATISTIQUES</button>
    </div>

    <!-- TAB 1: Classement actuel -->
    <div id="tab-current" class="tab-content active">
      <div class="period-controls">
        <span class="control-label">P√âRIODE:</span>
        <button class="period-btn" id="btnYear" onclick="selectYear()">üèÜ 2026</button>
        <select id="monthSelect" class="period-select" onchange="selectMonth()">
          <option value="01">Janvier</option>
          <option value="02">F√©vrier</option>
          <option value="03">Mars</option>
          <option value="04">Avril</option>
          <option value="05">Mai</option>
          <option value="06">Juin</option>
          <option value="07">Juillet</option>
          <option value="08">Ao√ªt</option>
          <option value="09">Septembre</option>
          <option value="10">Octobre</option>
          <option value="11">Novembre</option>
          <option value="12">D√©cembre</option>
        </select>
      </div>
      <div id="podiumSection" class="podium-section"></div>
      <div class="ranking-table-container">
        <table id="rankingTable">
          <thead>
            <tr>
              <th onclick="sortTable('rank')" id="th-rank">RANG<span class="sort-arrow" id="arrow-rank"></span></th>
              <th onclick="sortTable('name')" id="th-name">NOM<span class="sort-arrow" id="arrow-name"></span></th>
              <th onclick="sortTable('bookPages')" id="th-bookPages" title="Pages livres">üìö<span class="sort-arrow" id="arrow-bookPages"></span></th>
              <th onclick="sortTable('translationPages')" id="th-translationPages" title="Pages traductions">üîÑ<span class="sort-arrow" id="arrow-translationPages"></span></th>
              <th onclick="sortTable('articles')" id="th-articles" title="Articles">‚úçÔ∏è<span class="sort-arrow" id="arrow-articles"></span></th>
              <th onclick="sortTable('videos')" id="th-videos" title="Vid√©os">üé•<span class="sort-arrow" id="arrow-videos"></span></th>
              <th onclick="sortTable('audio')" id="th-audio" title="Audio (heures)">üéß<span class="sort-arrow" id="arrow-audio"></span></th>
              <th onclick="sortTable('score')" id="th-score">SCORE<span class="sort-arrow desc" id="arrow-score"></span></th>
              <th>BADGES</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB 2: Historique -->
    <div id="tab-history" class="tab-content">
      <div class="period-controls">
        <span class="control-label">ANN√âE:</span>
        <button class="period-btn active" data-year="all" onclick="showYearLeaderboard('all', this)">TOUTES</button>
        <button class="period-btn" data-year="2007" onclick="showYearLeaderboard(2007, this)">2007</button>
        <button class="period-btn" data-year="2008" onclick="showYearLeaderboard(2008, this)">2008</button>
        <button class="period-btn" data-year="2009" onclick="showYearLeaderboard(2009, this)">2009</button>
        <button class="period-btn" data-year="2010" onclick="showYearLeaderboard(2010, this)">2010</button>
        <button class="period-btn" data-year="2011" onclick="showYearLeaderboard(2011, this)">2011</button>
        <button class="period-btn" data-year="2012" onclick="showYearLeaderboard(2012, this)">2012</button>
        <button class="period-btn" data-year="2013" onclick="showYearLeaderboard(2013, this)">2013</button>
        <button class="period-btn" data-year="2014" onclick="showYearLeaderboard(2014, this)">2014</button>
        <button class="period-btn" data-year="2015" onclick="showYearLeaderboard(2015, this)">2015</button>
        <button class="period-btn" data-year="2016" onclick="showYearLeaderboard(2016, this)">2016</button>
        <button class="period-btn" data-year="2017" onclick="showYearLeaderboard(2017, this)">2017</button>
        <button class="period-btn" data-year="2018" onclick="showYearLeaderboard(2018, this)">2018</button>
        <button class="period-btn" data-year="2019" onclick="showYearLeaderboard(2019, this)">2019</button>
        <button class="period-btn" data-year="2020" onclick="showYearLeaderboard(2020, this)">2020</button>
        <button class="period-btn" data-year="2021" onclick="showYearLeaderboard(2021, this)">2021</button>
        <button class="period-btn" data-year="2022" onclick="showYearLeaderboard(2022, this)">2022</button>
        <button class="period-btn" data-year="2023" onclick="showYearLeaderboard(2023, this)">2023</button>
        <button class="period-btn" data-year="2024" onclick="showYearLeaderboard(2024, this)">2024</button>
        <button class="period-btn" data-year="2025" onclick="showYearLeaderboard(2025, this)">2025</button>
        <button class="period-btn" data-year="2026" onclick="showYearLeaderboard(2026, this)">2026</button>
      </div>

      <div id="historyPodiumSection" class="podium-section"></div>
      <div class="ranking-table-container">
        <table id="historyTable">
          <thead>
            <tr>
              <th onclick="sortHistoryTable('rank')" id="hth-rank">RANG<span class="sort-arrow" id="harrow-rank"></span></th>
              <th onclick="sortHistoryTable('name')" id="hth-name">NOM<span class="sort-arrow" id="harrow-name"></span></th>
              <th onclick="sortHistoryTable('bookPages')" id="hth-bookPages" title="Pages livres">üìö<span class="sort-arrow" id="harrow-bookPages"></span></th>
              <th onclick="sortHistoryTable('translationPages')" id="hth-translationPages" title="Pages traductions">üîÑ<span class="sort-arrow" id="harrow-translationPages"></span></th>
              <th onclick="sortHistoryTable('articles')" id="hth-articles" title="Articles">‚úçÔ∏è<span class="sort-arrow" id="harrow-articles"></span></th>
              <th onclick="sortHistoryTable('videos')" id="hth-videos" title="Vid√©os">üé•<span class="sort-arrow" id="harrow-videos"></span></th>
              <th onclick="sortHistoryTable('audio')" id="hth-audio" title="Audio (heures)">üéß<span class="sort-arrow" id="harrow-audio"></span></th>
              <th onclick="sortHistoryTable('score')" id="hth-score">SCORE<span class="sort-arrow desc" id="harrow-score"></span></th>
              <th>BADGES</th>
              <th>ACTION</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB 3: Statistiques -->
    <div id="tab-stats" class="tab-content">
      <div class="stats-grid" id="statsGrid"></div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-title">*** SYSTEM STATUS: RANKING COMPLETE ***</div>
    <div class="footer-info">
      Total contributeurs actifs: <span id="totalContributors">0</span><span class="blink-cursor"></span><br>
      Derni√®re mise √† jour: <span id="lastUpdate">--</span><br>
      run:vitalism//v2.1
    </div>
  </div>
</div>

<script>
const cursor = document.getElementById('cursor');
document.addEventListener('mousemove', e => {
  cursor.style.left = e.clientX + 'px';
  cursor.style.top = e.clientY + 'px';
});

let statsData = { contributors: [] };
let currentData = [];
let historyData = [];
let currentSortField = 'score';
let currentSortAsc = false;
let historySortField = 'score';
let historySortAsc = false;

// ============================================
// FORMULE DE SCORE
// ============================================
function getArticlePagesPerContributor(contributorName) {
  switch(contributorName) {
    case "Venehon": return 1;
    case "Caverne": return 5;
    case "Raffaello Bellino": return 5;
    default: return 3;
  }
}

function calculateScoreForYear(contributor, year) {
  const yearKey = 'y' + year;
  const data = contributor[yearKey];
  if (!data) return { score: 0, bookPages: 0, translationPages: 0, articlePages: 0, articles: 0, videos: 0, videoMinutes: 0, audioMinutes: 0 };
  
  // R√©cup√©rer les poids depuis le JSON centralis√©
  const weights = statsData.scoring?.weights || {
    page: 15, page_traduction: 7.5, video_minute: 7, audio_minute: 3.5, retweets: 1, likes: 0.3
  };
  
  // Pages des livres de cette ann√©e
  const yearBooks = (contributor.books || []).filter(b => b.year === year);
  const bookPages = yearBooks.reduce((sum, b) => sum + (b.pages || 0), 0);
  
  // Pages des traductions de cette ann√©e (50% du score)
  const yearTranslations = (contributor.translations || []).filter(t => t.year === year);
  const translationPages = yearTranslations.reduce((sum, t) => sum + (t.pages || 0), 0);
  
  // Nombre d'articles : utiliser le tableau articles[] si disponible, sinon yXXXX.articles
  const yearArticlesFromArray = (contributor.articles || []).filter(a => a.year === year);
  let articleCount = yearArticlesFromArray.length;
  
  // Si le tableau articles[] est vide, utiliser data.articles du yXXXX
  if (articleCount === 0 && data.articles > 0) {
    articleCount = data.articles;
  }
  
  // Calculer les pages d'articles
  let articlePages = 0;
  if (year >= 2026) {
    articlePages = yearArticlesFromArray.reduce((sum, a) => sum + (a.pages || 3), 0);
    if (articlePages === 0 && articleCount > 0) {
      const pagesPerArticle = getArticlePagesPerContributor(contributor.name);
      articlePages = articleCount * pagesPerArticle;
    }
  } else {
    const pagesPerArticle = getArticlePagesPerContributor(contributor.name);
    articlePages = articleCount * pagesPerArticle;
  }
  
  // Minutes vid√©o et audio
  const videoMinutes = data.video_minutes || 0;
  const audioMinutes = data.audio_minutes || 0;
  
  // Nouvelle formule
  const score = (bookPages * weights.page) + 
                (translationPages * weights.page_traduction) + 
                (articlePages * weights.page) + 
                (videoMinutes * weights.video_minute) + 
                (audioMinutes * weights.audio_minute) + 
                ((data.retweets || 0) * weights.retweets) + 
                ((data.likes || 0) * weights.likes);
  
  return {
    score: Math.round(score),
    bookPages: bookPages,
    translationPages: translationPages,
    articlePages: articlePages,
    articles: articleCount,
    videos: Math.round(videoMinutes / 60),
    videoMinutes: videoMinutes,
    audioMinutes: audioMinutes
  };
}

function calculateTotalStats(contributor) {
  let totals = { score: 0, bookPages: 0, translationPages: 0, articlePages: 0, articles: 0, videos: 0 };
  
  for (let y = 2007; y <= 2025; y++) {
    const yearStats = calculateScoreForYear(contributor, y);
    totals.score += yearStats.score;
    totals.bookPages += yearStats.bookPages;
    totals.translationPages += yearStats.translationPages;
    totals.articlePages += yearStats.articlePages;
    totals.articles += yearStats.articles;
    totals.videos += yearStats.videos;
  }
  
  return totals;
}

function getBadges(rank, score, totalPages, contributor) {
  const badges = [];
  
  // Badges de rang
  if(rank === 1) badges.push({text:'ü•á TOP 1', type:'gold'});
  else if(rank === 2) badges.push({text:'ü•à TOP 2', type:'silver'});
  else if(rank === 3) badges.push({text:'ü•â TOP 3', type:'bronze'});
  else if(rank <= 10) badges.push({text:'üèÖ TOP 10', type:'silver'});
  
  // Badges de production
  if(totalPages >= 1000) badges.push({text:'üìö BOOK MASTER', type:'gold'});
  else if(totalPages >= 500) badges.push({text:'üìö AUTEUR', type:'silver'});
  
  // Badges de score
  if(score >= 50000) badges.push({text:'üëë L√âGENDE', type:'gold'});
  else if(score >= 10000) badges.push({text:'‚ö° ELITE', type:'gold'});
  else if(score >= 5000) badges.push({text:'üí™ CONFIRMED', type:'silver'});
  
  // Badges de traduction (si contributor est fourni)
  if(contributor) {
    const translations = contributor.translations || [];
    if(translations.length >= 10) badges.push({text:'üåç POLYGLOT', type:'gold'});
    else if(translations.length >= 1) badges.push({text:'üîÑ TRANSLATOR', type:'silver'});
    
    // Badges vid√©o/audio
    const currentYear = new Date().getFullYear();
    const yearData = contributor['y' + currentYear] || {};
    if(yearData.video_minutes >= 60) badges.push({text:'üé¨ FILMMAKER', type:'gold'});
    else if(yearData.video_minutes >= 10) badges.push({text:'üìπ VIDEOGRAPHER', type:'silver'});
    if(yearData.audio_minutes >= 120) badges.push({text:'üéôÔ∏è PODCASTER', type:'gold'});
    else if(yearData.audio_minutes >= 30) badges.push({text:'üîä SPEAKER', type:'silver'});
  }
  
  return badges;
}

// ============================================
// CHARGEMENT DES DONN√âES
// ============================================
async function loadData() {
  try {
    const response = await fetch('data.json');
    const data = await response.json();
    statsData = data;
    console.log('‚úÖ Donn√©es charg√©es:', statsData.contributors.length, 'contributeurs');
    
    initPeriodControls();
    initCurrentTab();
    showYearLeaderboard('all', document.querySelector('#tab-history .period-btn.active'));
    generateStats();
    
    document.getElementById('totalContributors').textContent = statsData.contributors.length;
    document.getElementById('lastUpdate').textContent = new Date(statsData.lastUpdate).toLocaleString('fr-FR');
  } catch (error) {
    console.error('‚ùå Erreur:', error);
  }
}

loadData();

// ============================================
// ONGLET CLASSEMENT ACTUEL
// ============================================
let currentPeriod = 'month'; // 'year' ou 'month'
let currentMonth = String(new Date().getMonth() + 1).padStart(2, '0'); // mois actuel auto

function selectYear() {
  currentPeriod = 'year';
  document.getElementById('btnYear').classList.add('active');
  document.getElementById('monthSelect').value = '';
  initCurrentTab();
}

function selectMonth() {
  currentPeriod = 'month';
  currentMonth = document.getElementById('monthSelect').value;
  document.getElementById('btnYear').classList.remove('active');
  initCurrentTab();
}

function initPeriodControls() {
  // S√©lectionner le mois actuel par d√©faut
  document.getElementById('monthSelect').value = currentMonth;
}

function calculateMonthStats(c, month) {
  const monthKeys = ['janvier', 'fevrier', 'mars', 'avril', 'mai', 'juin', 
                     'juillet', 'aout', 'septembre', 'octobre', 'novembre', 'decembre'];
  const monthIndex = parseInt(month) - 1;
  const monthKey = monthKeys[monthIndex];
  
  // R√©cup√©rer les poids depuis le JSON centralis√©
  const weights = statsData.scoring?.weights || {
    page: 15, page_traduction: 7.5, video_minute: 7, audio_minute: 3.5, retweets: 1, likes: 0.3
  };
  
  const m = c.months?.[monthKey] || {};
  const pagesLivres = m.pages_livres || 0;
  const pagesArticles = m.pages_articles || 0;
  const videoMin = m.video_minutes || 0;
  const audioMin = m.audio_minutes || 0;
  
  const score = (pagesLivres * weights.page) + 
                (pagesArticles * weights.page) + 
                (videoMin * weights.video_minute) + 
                (audioMin * weights.audio_minute) + 
                ((m.retweets || 0) * weights.retweets) + 
                ((m.likes || 0) * weights.likes);
  
  return {
    bookPages: pagesLivres,
    translationPages: 0,
    articlePages: pagesArticles,
    articles: Math.round(pagesArticles / 5),
    videos: Math.round(videoMin / 60),
    videoMinutes: videoMin,
    audioMinutes: audioMin,
    score: Math.round(score)
  };
}

function calculateYearStats(c) {
  // Score de l'ann√©e en cours
  const currentYear = new Date().getFullYear();
  return calculateScoreForYear(c, currentYear);
}

function initCurrentTab() {
  if (currentPeriod === 'year') {
    // ANN√âE - score de l'ann√©e en cours
    currentData = statsData.contributors.map(c => {
      const stats = calculateYearStats(c);
      return {
        name: c.name,
        file: c.file,
        bookPages: stats.bookPages,
        translationPages: stats.translationPages,
        articlePages: stats.articlePages,
        totalPages: stats.bookPages + stats.translationPages + stats.articlePages,
        articles: stats.articles,
        videos: stats.videos,
        audio: Math.round(stats.audioMinutes / 60),
        score: stats.score,
        contributor: c
      };
    });
  } else {
    // Mois sp√©cifique
    currentData = statsData.contributors.map(c => {
      const stats = calculateMonthStats(c, currentMonth);
      return {
        name: c.name,
        file: c.file,
        bookPages: stats.bookPages,
        translationPages: stats.translationPages,
        articlePages: stats.articlePages,
        totalPages: stats.bookPages + stats.translationPages + stats.articlePages,
        articles: stats.articles,
        videos: stats.videos,
        audio: Math.round(stats.audioMinutes / 60),
        score: stats.score,
        contributor: c
      };
    });
  }
  
  sortCurrentData();
  renderCurrentTab();
}

function sortCurrentData() {
  currentData.sort((a, b) => {
    let valA, valB;
    switch(currentSortField) {
      case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
      case 'bookPages': valA = a.bookPages; valB = b.bookPages; break;
      case 'translationPages': valA = a.translationPages; valB = b.translationPages; break;
      case 'articles': valA = a.articles; valB = b.articles; break;
      case 'videos': valA = a.videos; valB = b.videos; break;
      case 'audio': valA = a.audio || 0; valB = b.audio || 0; break;
      case 'score': default: valA = a.score; valB = b.score; break;
    }
    if (currentSortAsc) return valA > valB ? 1 : -1;
    return valA < valB ? 1 : -1;
  });
}

function renderCurrentTab() {
  // Podium
  const podiumSection = document.getElementById('podiumSection');
  const top3 = currentData.slice(0, 3);
  podiumSection.innerHTML = top3.map((c, idx) => `
    <div class="podium-card rank-${idx + 1}">
      <div class="podium-rank">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}</div>
      <div class="podium-name">${c.name}</div>
      <div class="podium-score">${c.score.toLocaleString('fr-FR')} pts</div>
      <div class="podium-stats">
        üìö ${c.bookPages.toLocaleString('fr-FR')} p. | üîÑ ${c.translationPages.toLocaleString('fr-FR')} p. | ‚úçÔ∏è ${c.articles} art. | üé• ${c.videos} vid. | üéß ${c.audio || 0}h
      </div>
      <a href="${c.file}" class="podium-view-btn">VOIR PROFIL</a>
    </div>
  `).join('');
  
  // Table (√† partir du rang 4)
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = currentData.slice(3).map((c, idx) => {
    const rank = idx + 4;
    const badges = getBadges(rank, c.score, c.totalPages, c.contributor);
    const badgesHtml = badges.map(b => `<span class="badge ${b.type}">${b.text}</span>`).join('');
    return `
      <tr>
        <td>${rank}</td>
        <td><a href="${c.file}" class="contributor-link">${c.name}</a></td>
        <td>${c.bookPages.toLocaleString('fr-FR')}</td>
        <td>${c.translationPages.toLocaleString('fr-FR')}</td>
        <td>${c.articles}</td>
        <td>${c.videos}</td>
        <td>${c.audio || 0}</td>
        <td class="score-cell">${c.score.toLocaleString('fr-FR')}</td>
        <td>${badgesHtml}</td>
        <td><a href="${c.file}" class="view-btn">VOIR</a></td>
      </tr>
    `;
  }).join('');
}

function sortTable(field) {
  if (currentSortField === field) {
    currentSortAsc = !currentSortAsc;
  } else {
    currentSortField = field;
    currentSortAsc = false;
  }
  sortCurrentData();
  renderCurrentTab();
  updateSortArrows();
}

function updateSortArrows() {
  // Reset all arrows
  ['rank', 'name', 'bookPages', 'translationPages', 'articles', 'videos', 'audio', 'score'].forEach(f => {
    const arrow = document.getElementById('arrow-' + f);
    if (arrow) {
      arrow.className = 'sort-arrow';
    }
  });
  // Set active arrow
  const activeArrow = document.getElementById('arrow-' + currentSortField);
  if (activeArrow) {
    activeArrow.className = 'sort-arrow ' + (currentSortAsc ? 'asc' : 'desc');
  }
}

// ============================================
// ONGLET HISTORIQUE
// ============================================
function showYearLeaderboard(year, btn) {
  // Boutons actifs
  document.querySelectorAll('#tab-history .period-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  
  historyData = statsData.contributors.map(c => {
    let stats;
    if (year === 'all') {
      stats = calculateTotalStats(c);
    } else {
      stats = calculateScoreForYear(c, year);
    }
    return {
      name: c.name,
      file: c.file,
      bookPages: stats.bookPages,
      translationPages: stats.translationPages,
      articlePages: stats.articlePages,
      totalPages: stats.bookPages + stats.translationPages + stats.articlePages,
      articles: stats.articles,
      videos: stats.videos,
      score: stats.score,
      contributor: c
    };
  });
  
  sortHistoryData();
  renderHistoryTab();
}

function sortHistoryData() {
  historyData.sort((a, b) => {
    let valA, valB;
    switch(historySortField) {
      case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
      case 'bookPages': valA = a.bookPages; valB = b.bookPages; break;
      case 'translationPages': valA = a.translationPages; valB = b.translationPages; break;
      case 'articles': valA = a.articles; valB = b.articles; break;
      case 'videos': valA = a.videos; valB = b.videos; break;
      case 'audio': valA = a.audio || 0; valB = b.audio || 0; break;
      case 'score': default: valA = a.score; valB = b.score; break;
    }
    if (historySortAsc) return valA > valB ? 1 : -1;
    return valA < valB ? 1 : -1;
  });
}

function renderHistoryTab() {
  // Podium
  const podiumSection = document.getElementById('historyPodiumSection');
  const top3 = historyData.slice(0, 3);
  podiumSection.innerHTML = top3.map((c, idx) => `
    <div class="podium-card rank-${idx + 1}">
      <div class="podium-rank">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}</div>
      <div class="podium-name">${c.name}</div>
      <div class="podium-score">${c.score.toLocaleString('fr-FR')} pts</div>
      <div class="podium-stats">
        üìö ${c.bookPages.toLocaleString('fr-FR')} p. | üîÑ ${c.translationPages.toLocaleString('fr-FR')} p. | ‚úçÔ∏è ${c.articles} art. | üé• ${c.videos} vid. | üéß ${c.audio || 0}h
      </div>
      <a href="${c.file}" class="podium-view-btn">VOIR PROFIL</a>
    </div>
  `).join('');
  
  // Table
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = historyData.slice(3).map((c, idx) => {
    const rank = idx + 4;
    const badges = getBadges(rank, c.score, c.totalPages, c.contributor);
    const badgesHtml = badges.map(b => `<span class="badge ${b.type}">${b.text}</span>`).join('');
    return `
      <tr>
        <td>${rank}</td>
        <td><a href="${c.file}" class="contributor-link">${c.name}</a></td>
        <td>${c.bookPages.toLocaleString('fr-FR')}</td>
        <td>${c.translationPages.toLocaleString('fr-FR')}</td>
        <td>${c.articles}</td>
        <td>${c.videos}</td>
        <td class="score-cell">${c.score.toLocaleString('fr-FR')}</td>
        <td>${badgesHtml}</td>
        <td><a href="${c.file}" class="view-btn">VOIR</a></td>
      </tr>
    `;
  }).join('');
}

function sortHistoryTable(field) {
  if (historySortField === field) {
    historySortAsc = !historySortAsc;
  } else {
    historySortField = field;
    historySortAsc = false;
  }
  sortHistoryData();
  renderHistoryTab();
  updateHistorySortArrows();
}

function updateHistorySortArrows() {
  // Reset all arrows
  ['rank', 'name', 'bookPages', 'translationPages', 'articles', 'videos', 'audio', 'score'].forEach(f => {
    const arrow = document.getElementById('harrow-' + f);
    if (arrow) {
      arrow.className = 'sort-arrow';
    }
  });
  // Set active arrow
  const activeArrow = document.getElementById('harrow-' + historySortField);
  if (activeArrow) {
    activeArrow.className = 'sort-arrow ' + (historySortAsc ? 'asc' : 'desc');
  }
}

// ============================================
// ONGLET STATISTIQUES
// ============================================
function generateStats() {
  let totals = { bookPages: 0, translationPages: 0, articles: 0, videos: 0, score: 0 };
  
  statsData.contributors.forEach(c => {
    const stats = calculateTotalStats(c);
    totals.bookPages += stats.bookPages;
    totals.translationPages += stats.translationPages;
    totals.articles += stats.articles;
    totals.videos += stats.videos;
    totals.score += stats.score;
  });
  
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-icon">üìö</div>
      <div class="stat-value">${totals.bookPages.toLocaleString('fr-FR')}</div>
      <div class="stat-label">PAGES LIVRES</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üîÑ</div>
      <div class="stat-value">${totals.translationPages.toLocaleString('fr-FR')}</div>
      <div class="stat-label">PAGES TRADUCTIONS</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úçÔ∏è</div>
      <div class="stat-value">${totals.articles.toLocaleString('fr-FR')}</div>
      <div class="stat-label">ARTICLES</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üé•</div>
      <div class="stat-value">${totals.videos.toLocaleString('fr-FR')}</div>
      <div class="stat-label">VID√âOS</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ö°</div>
      <div class="stat-value">${totals.score.toLocaleString('fr-FR')}</div>
      <div class="stat-label">SCORE TOTAL</div>
    </div>
  `;
}

// ============================================
// NAVIGATION ONGLETS
// ============================================
function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tabName).classList.add('active');
}

// SECRET: ladies.mp4 - cliquer sur la m√©daille ü•á du podium
document.addEventListener('click',e=>{
  const podiumRank=e.target.closest('.podium-rank');
  if(podiumRank && podiumRank.textContent.includes('ü•á')){
    const popup=document.createElement('div');
    popup.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000';
    popup.innerHTML='<video src="ladies.mp4" controls autoplay style="max-width:80%;max-height:80%"></video>';
    popup.onclick=()=>popup.remove();
    document.body.appendChild(popup);
  }
});
</script>
</body>
</html>
